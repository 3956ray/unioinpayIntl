# EscrowContract PRD - æ‰˜ç®¡åˆçº¦äº§å“éœ€æ±‚æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

### äº§å“å®šä½
åŸºäºCoinbase Commerce Payments Protocolçš„å»ä¸­å¿ƒåŒ–æ‰˜ç®¡åˆçº¦ï¼Œä¸ºç”µå•†æ”¯ä»˜æä¾›å®‰å…¨çš„èµ„é‡‘æ‰˜ç®¡æœåŠ¡ã€‚å®ç°ç”¨æˆ·æ— Gasè´¹çš„æ”¯ä»˜ä½“éªŒï¼ŒåŒæ—¶ä¿è¯èµ„é‡‘å®‰å…¨å’Œäº¤æ˜“çš„å»ä¸­å¿ƒåŒ–ç‰¹æ€§ã€‚

### æ ¸å¿ƒä»·å€¼
- **ç”¨æˆ·å‹å¥½**ï¼šç”¨æˆ·åªéœ€ç­¾åç¡®è®¤ï¼Œæ— éœ€æ”¯ä»˜Gasè´¹ç”¨
- **èµ„é‡‘å®‰å…¨**ï¼šæ™ºèƒ½åˆçº¦æ‰˜ç®¡ï¼Œé˜²æ­¢èµ„é‡‘è¢«æ¶æ„ä½¿ç”¨
- **å»ä¸­å¿ƒåŒ–**ï¼šæ— éœ€ä¿¡ä»»ç¬¬ä¸‰æ–¹ï¼Œå®Œå…¨ç”±æ™ºèƒ½åˆçº¦æ§åˆ¶
- **æ ‡å‡†å…¼å®¹**ï¼šæ”¯æŒEIP-2612 Permitå’ŒPermit2æˆæƒæœºåˆ¶

## MVPåŠŸèƒ½èŒƒå›´

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒæ‰˜ç®¡åŠŸèƒ½ (MVP)

#### âœ… å¿…é¡»å®ç°çš„åŠŸèƒ½
- [ ] **æ”¯ä»˜æ„å›¾éªŒè¯ä¸æˆæƒ**
  - EIP-712ç»“æ„åŒ–ç­¾åéªŒè¯
  - Permit2æˆæƒé›†æˆ
  - èµ„é‡‘ä»ç”¨æˆ·è½¬å…¥æ‰˜ç®¡åˆçº¦

- [ ] **æ”¯ä»˜æ•è·åŠŸèƒ½**
  - å•†å®¶å±¥çº¦åé‡Šæ”¾èµ„é‡‘
  - èµ„é‡‘ä»æ‰˜ç®¡åˆçº¦è½¬ç»™å•†å®¶
  - çŠ¶æ€ç®¡ç†å’Œäº‹ä»¶è®°å½•

- [ ] **é€€æ¬¾å¤„ç†åŠŸèƒ½**
  - ç”¨æˆ·ä¸»åŠ¨é€€æ¬¾
  - è¶…æ—¶è‡ªåŠ¨é€€æ¬¾
  - èµ„é‡‘é€€å›åŸä»˜æ¬¾ç”¨æˆ·

- [ ] **æ“ä½œå‘˜æƒé™ç®¡ç†**
  - Operatoræ³¨å†Œå’Œç®¡ç†
  - æƒé™éªŒè¯æœºåˆ¶
  - åŸºç¡€è®¿é—®æ§åˆ¶

- [ ] **åŸºç¡€å®‰å…¨æœºåˆ¶**
  - é‡å…¥æ”»å‡»é˜²æŠ¤
  - æ—¶é—´é”å®šæœºåˆ¶
  - ç´§æ€¥æš‚åœåŠŸèƒ½

#### ğŸ”„ ç¬¬äºŒé˜¶æ®µåŠŸèƒ½ (åç»­ç‰ˆæœ¬)
- [ ] æ‰¹é‡æ“ä½œæ”¯æŒ
- [ ] å¤šä»£å¸æ”¯æŒæ‰©å±•
- [ ] äº‰è®®è§£å†³æœºåˆ¶
- [ ] æ‰‹ç»­è´¹ç®¡ç†
- [ ] åˆçº¦å‡çº§æœºåˆ¶

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒåˆçº¦ç»“æ„
```
EscrowContract
â”œâ”€â”€ æ”¯ä»˜æ„å›¾ç®¡ç†
â”‚   â”œâ”€â”€ PaymentIntentç»“æ„ä½“
â”‚   â”œâ”€â”€ EIP-712ç­¾åéªŒè¯
â”‚   â””â”€â”€ çŠ¶æ€è·Ÿè¸ª
â”œâ”€â”€ Permit2é›†æˆ
â”‚   â”œâ”€â”€ æˆæƒéªŒè¯
â”‚   â”œâ”€â”€ èµ„é‡‘è½¬ç§»
â”‚   â””â”€â”€ æ— Gasä½“éªŒ
â”œâ”€â”€ æ‰˜ç®¡ç®¡ç†
â”‚   â”œâ”€â”€ èµ„é‡‘é”å®š
â”‚   â”œâ”€â”€ çŠ¶æ€å˜æ›´
â”‚   â””â”€â”€ äº‹ä»¶è®°å½•
â””â”€â”€ å®‰å…¨æœºåˆ¶
    â”œâ”€â”€ æƒé™æ§åˆ¶
    â”œâ”€â”€ é‡å…¥é˜²æŠ¤
    â””â”€â”€ ç´§æ€¥æ§åˆ¶
```

### æ•°æ®ç»“æ„è®¾è®¡

#### PaymentIntent æ”¯ä»˜æ„å›¾
```solidity
struct PaymentIntent {
    address payer;          // ä»˜æ¬¾æ–¹
    address payee;          // æ”¶æ¬¾æ–¹
    address token;          // ä»£å¸åœ°å€
    uint256 amount;         // æ”¯ä»˜é‡‘é¢
    uint256 e piryTime;     // è¿‡æœŸæ—¶é—´
    bytes32 intentHash;     // æ„å›¾å“ˆå¸Œ
    uint256 nonce;          // é˜²é‡æ”¾éšæœºæ•°
}
```

#### EscrowRecord æ‰˜ç®¡è®°å½•
```solidity
struct EscrowRecord {
    address payer;          // ä»˜æ¬¾æ–¹
    address payee;          // æ”¶æ¬¾æ–¹
    address token;          // ä»£å¸åœ°å€
    uint256 amount;         // æ‰˜ç®¡é‡‘é¢
    uint256 createdAt;      // åˆ›å»ºæ—¶é—´
    uint256 e piryTime;     // è¿‡æœŸæ—¶é—´
    Status status;          // æ‰˜ç®¡çŠ¶æ€
    address operator;       // æ“ä½œå‘˜
}

enum Status {
    NONE,           // ä¸å­˜åœ¨
    AUTHORIZED,     // å·²æˆæƒ
    CAPTURED,       // å·²æ•è·
    REFUNDED,       // å·²é€€æ¬¾
    E PIRED         // å·²è¿‡æœŸ
}
```

## æ ¸å¿ƒåŠŸèƒ½è¯¦è¿°

### 1. æ”¯ä»˜æˆæƒæµç¨‹

#### åŠŸèƒ½æè¿°
ç”¨æˆ·é€šè¿‡ç¦»çº¿ç­¾ååˆ›å»ºæ”¯ä»˜æ„å›¾ï¼ŒOperatorä»£ä¸ºæäº¤åˆ°åŒºå—é“¾ï¼Œå®ç°æ— Gasæ”¯ä»˜ä½“éªŒã€‚

#### æ ¸å¿ƒå‡½æ•°
```solidity
function authorizePaymentWithPermit2(
    PaymentIntent calldata intent,
    bytes calldata intentSignature,
    ISignatureTransfer.PermitTransferFrom calldata permit,
    bytes calldata permitSignature
) e ternal onlyOperator
```

#### éªŒè¯æ­¥éª¤
1. éªŒè¯æ”¯ä»˜æ„å›¾EIP-712ç­¾å
2. éªŒè¯Permit2æˆæƒç­¾å
3. æ£€æŸ¥æ”¯ä»˜æ„å›¾æœ‰æ•ˆæœŸ
4. éªŒè¯Operatoræƒé™
5. æ‰§è¡Œèµ„é‡‘è½¬ç§»
6. åˆ›å»ºæ‰˜ç®¡è®°å½•

### 2. æ”¯ä»˜æ•è·æµç¨‹

#### åŠŸèƒ½æè¿°
å•†å®¶å±¥è¡Œä¹‰åŠ¡åï¼ŒOperatorè°ƒç”¨æ•è·å‡½æ•°ï¼Œå°†æ‰˜ç®¡èµ„é‡‘è½¬ç§»ç»™å•†å®¶ã€‚

#### æ ¸å¿ƒå‡½æ•°
```solidity
function capturePayment(
    bytes32 intentHash
) e ternal onlyOperator
```

#### æ‰§è¡Œæ­¥éª¤
1. éªŒè¯æ‰˜ç®¡è®°å½•å­˜åœ¨ä¸”çŠ¶æ€ä¸ºAUTHORIZED
2. æ£€æŸ¥è°ƒç”¨è€…æƒé™
3. è½¬ç§»èµ„é‡‘ç»™æ”¶æ¬¾æ–¹
4. æ›´æ–°çŠ¶æ€ä¸ºCAPTURED
5. å‘å‡ºPaymentCapturedäº‹ä»¶

### 3. é€€æ¬¾å¤„ç†æµç¨‹

#### åŠŸèƒ½æè¿°
å¤„ç†è®¢å•å–æ¶ˆã€äº‰è®®æˆ–è¶…æ—¶æƒ…å†µï¼Œå°†èµ„é‡‘é€€å›ç»™åŸä»˜æ¬¾ç”¨æˆ·ã€‚

#### æ ¸å¿ƒå‡½æ•°
```solidity
function refundPayment(
    bytes32 intentHash,
    string calldata reason
) e ternal

function autoRefundE pired(
    bytes32 intentHash
) e ternal
```

#### é€€æ¬¾æ¡ä»¶
- ç”¨æˆ·ä¸»åŠ¨ç”³è¯·é€€æ¬¾
- å•†å®¶åŒæ„é€€æ¬¾
- æ”¯ä»˜æ„å›¾è¿‡æœŸ
- ç³»ç»Ÿæ£€æµ‹åˆ°å¼‚å¸¸

## å®‰å…¨æœºåˆ¶

### 1. æƒé™æ§åˆ¶
- **Operatoræ³¨å†Œ**ï¼šåªæœ‰æ³¨å†Œçš„Operatorå¯ä»¥æ‰§è¡Œæ“ä½œ
- **å¤šé‡éªŒè¯**ï¼šæ”¯ä»˜æ„å›¾å’Œæˆæƒéƒ½éœ€è¦ç”¨æˆ·ç­¾å
- **æ—¶é—´é™åˆ¶**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰æ˜ç¡®çš„æ—¶é—´çª—å£

### 2. é˜²æ”»å‡»æœºåˆ¶
- **é‡å…¥é˜²æŠ¤**ï¼šä½¿ç”¨ReentrancyGuardé˜²æ­¢é‡å…¥æ”»å‡»
- **ç­¾åéªŒè¯**ï¼šä¸¥æ ¼éªŒè¯æ‰€æœ‰EIP-712å’ŒPermit2ç­¾å
- **çŠ¶æ€æ£€æŸ¥**ï¼šæ¯æ¬¡æ“ä½œå‰æ£€æŸ¥åˆçº¦å’Œè®°å½•çŠ¶æ€

### 3. ç´§æ€¥æ§åˆ¶
- **æš‚åœæœºåˆ¶**ï¼šç®¡ç†å‘˜å¯ä»¥æš‚åœåˆçº¦æ“ä½œ
- **ç´§æ€¥æå–**ï¼šåœ¨ç´§æ€¥æƒ…å†µä¸‹ä¿æŠ¤ç”¨æˆ·èµ„é‡‘
- **å‡çº§æ”¯æŒ**ï¼šæ”¯æŒåˆçº¦é€»è¾‘å‡çº§

## äº‹ä»¶ç³»ç»Ÿ

### æ ¸å¿ƒäº‹ä»¶å®šä¹‰
```solidity
event PaymentAuthorized(
    bytes32 inde ed intentHash,
    address inde ed payer,
    address inde ed payee,
    address token,
    uint256 amount,
    uint256 e piryTime
);

event PaymentCaptured(
    bytes32 inde ed intentHash,
    address inde ed operator,
    uint256 amount
);

event PaymentRefunded(
    bytes32 inde ed intentHash,
    address inde ed refundRecipient,
    uint256 amount,
    string reason
);

event OperatorRegistered(
    address inde ed operator,
    string name
);
```

## ä¸RMBTokené›†æˆ

### é›†æˆè¦ç‚¹
- **Permitæ”¯æŒ**ï¼šå……åˆ†åˆ©ç”¨RMBTokençš„EIP-2612 PermitåŠŸèƒ½
- **ç²¾åº¦å¤„ç†**ï¼šæ­£ç¡®å¤„ç†RMBTokençš„6ä½å°æ•°ç²¾åº¦
- **æƒé™å…¼å®¹**ï¼šä¸RMBTokençš„æƒé™ç³»ç»ŸååŒå·¥ä½œ
- **å®‰å…¨ååŒ**ï¼šåˆ©ç”¨RMBTokençš„å®‰å…¨æœºåˆ¶

### ç‰¹æ®Šå¤„ç†
- **é“¸é€ é™åˆ¶**ï¼šè€ƒè™‘RMBTokençš„å•æ¬¡é“¸é€ é™åˆ¶ï¼ˆ100ä¸‡RMBï¼‰
- **æš‚åœçŠ¶æ€**ï¼šæ£€æŸ¥RMBTokençš„æš‚åœçŠ¶æ€
- **é‡å…¥é˜²æŠ¤**ï¼šä¸RMBTokençš„é‡å…¥é˜²æŠ¤æœºåˆ¶ååŒ

## éƒ¨ç½²è¦æ±‚

### ä¾èµ–åˆçº¦
- **Permit2åˆçº¦**ï¼šUniswapçš„ç»Ÿä¸€æˆæƒåˆçº¦
- **RMBTokenåˆçº¦**ï¼šé¡¹ç›®çš„äººæ°‘å¸ç¨³å®šå¸
- **OpenZeppelinåº“**ï¼šå®‰å…¨åŸºç¡€ç»„ä»¶

### åˆå§‹åŒ–å‚æ•°
- Permit2åˆçº¦åœ°å€
- ç®¡ç†å‘˜åœ°å€
- æ”¯æŒçš„ä»£å¸åˆ—è¡¨ï¼ˆåŒ…æ‹¬RMBTokenï¼‰
- é»˜è®¤è¿‡æœŸæ—¶é—´è®¾ç½®

### ç½‘ç»œæ”¯æŒ
- ä»¥å¤ªåŠä¸»ç½‘
- Polygon
- Arbitrum
- Optimism

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- æ”¯ä»˜æ„å›¾éªŒè¯æµ‹è¯•
- Permit2é›†æˆæµ‹è¯•
- çŠ¶æ€è½¬æ¢æµ‹è¯•
- æƒé™æ§åˆ¶æµ‹è¯•
- å®‰å…¨æœºåˆ¶æµ‹è¯•

### é›†æˆæµ‹è¯•
- ä¸RMBTokençš„å®Œæ•´äº¤äº’æµç¨‹
- å¤šç”¨æˆ·å¹¶å‘æµ‹è¯•
- å¼‚å¸¸æƒ…å†µå¤„ç†æµ‹è¯•
- Gasä¼˜åŒ–éªŒè¯

### å®‰å…¨å®¡è®¡
- æ™ºèƒ½åˆçº¦å®‰å…¨å®¡è®¡
- ç»æµæ¨¡å‹éªŒè¯
- æ”»å‡»å‘é‡åˆ†æ
- å½¢å¼åŒ–éªŒè¯

## æ€§èƒ½æŒ‡æ ‡

### Gasæ¶ˆè€—ç›®æ ‡
- æ”¯ä»˜æˆæƒï¼š< 150,000 gas
- æ”¯ä»˜æ•è·ï¼š< 80,000 gas
- é€€æ¬¾å¤„ç†ï¼š< 80,000 gas

### å“åº”æ—¶é—´
- ç­¾åéªŒè¯ï¼š< 100ms
- çŠ¶æ€æŸ¥è¯¢ï¼š< 50ms
- äº‹ä»¶ç›‘å¬ï¼šå®æ—¶

## é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©
- **æ™ºèƒ½åˆçº¦æ¼æ´**ï¼šé€šè¿‡å®¡è®¡å’Œæµ‹è¯•é™ä½
- **Permit2ä¾èµ–**ï¼šä½¿ç”¨æˆç†Ÿçš„Uniswapåˆçº¦
- **ç½‘ç»œæ‹¥å µ**ï¼šæ”¯æŒå¤šé“¾éƒ¨ç½²åˆ†æ•£é£é™©

### ä¸šåŠ¡é£é™©
- **ç”¨æˆ·æ¥å—åº¦**ï¼šæä¾›æ¸…æ™°çš„ç”¨æˆ·æ•™è‚²
- **ç›‘ç®¡åˆè§„**ï¼šéµå¾ªç›¸å…³æ³•å¾‹æ³•è§„
- **ç«äº‰å‹åŠ›**ï¼šæŒç»­ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

## å‘å¸ƒè®¡åˆ’

### MVPç‰ˆæœ¬ (v1.0.0)
- æ ¸å¿ƒæ‰˜ç®¡åŠŸèƒ½
- RMBTokené›†æˆ
- åŸºç¡€å®‰å…¨æœºåˆ¶
- æµ‹è¯•ç½‘éƒ¨ç½²

### å¢å¼ºç‰ˆæœ¬ (v1.1.0)
- æ‰¹é‡æ“ä½œæ”¯æŒ
- å¤šä»£å¸æ‰©å±•
- æ€§èƒ½ä¼˜åŒ–
- ä¸»ç½‘éƒ¨ç½²

### å®Œæ•´ç‰ˆæœ¬ (v2.0.0)
- äº‰è®®è§£å†³æœºåˆ¶
- é«˜çº§å®‰å…¨åŠŸèƒ½
- è·¨é“¾æ”¯æŒ
- ä¼ä¸šçº§åŠŸèƒ½

## æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- åˆçº¦éƒ¨ç½²æˆåŠŸç‡ï¼š100%
- äº¤æ˜“æˆåŠŸç‡ï¼š> 99.9%
- å¹³å‡Gasæ¶ˆè€—è¾¾æ ‡
- é›¶å®‰å…¨äº‹æ•…

### ä¸šåŠ¡æŒ‡æ ‡
- ç”¨æˆ·é‡‡ç”¨ç‡å¢é•¿
- äº¤æ˜“é‡å¢é•¿
- ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ†
- ç”Ÿæ€ç³»ç»Ÿé›†æˆæ•°é‡

---

**ç‰ˆæœ¬**: 1.0.0-MVP  
**æœ€åæ›´æ–°**: 2024å¹´  
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ