# ☕ 小明买咖啡完整测试流程

## 📋 测试概述

本文档提供了完整的小明买咖啡支付流程测试指南，包含两种支付方式：
1. **简单支付** (使用 SimpleTokenCollector)
2. **ERC3009 签名支付** (使用 ERC3009PaymentCollector)

---

## 🛠️ 前置准备

### 1. 环境检查
```bash
# 确保在正确的目录
cd chainPart

# 检查依赖
npm list --depth=0
```

### 2. 启动本地区块链
```bash
# 在终端1中运行（保持运行状态）
npx hardhat node
```

**预期输出**: 显示10个测试账户和私钥

---

## 🚀 第一阶段：基础设施部署

### 步骤 1: 部署核心合约
```bash
# 部署 RMBToken 和 Escrow 合约
npx hardhat run scripts/deploy-all.js --network localhost
```

**预期输出**:
```
🚀 开始部署所有合约...
✅ RMBToken 部署成功! 地址: 0x...
✅ Escrow 部署成功! 地址: 0x...
✅ TokenStore 实现部署成功! 地址: 0x...
```

### 步骤 2: 验证基础部署
```bash
# 验证所有合约部署状态
npx hardhat run scripts/verify-deployment.js --network localhost
```

**预期输出**: 显示所有合约地址和状态

---


### 选项 A: ERC3009 签名支付流程

#### 步骤 3A: 部署 ERC3009PaymentCollector
```bash
npx hardhat run scripts/deploy-erc3009-collector.js --network localhost
```

#### 步骤 4A: 测试 ERC3009 签名支付
```bash
npx hardhat run scripts/coffee-payment-erc3009-demo.js --network localhost
```

**预期结果**:
- ✅ ERC3009 签名生成成功
- ✅ 支付授权验证通过
- ✅ 代币转账成功
- ✅ 费用分配正确

---

## ☕ 第三阶段：完整咖啡购买演示


### ERC3009 签名支付演示 (高级功能)

```bash
# 运行 ERC3009 签名支付演示
npx hardhat run scripts/coffee-payment-erc3009-demo.js --network localhost
```

**测试场景**:
- 👤 小明 (付款人)
- ☕ 咖啡店 (收款人)
- 🏢 操作员 (费用接收者)
- 💰 支付金额: 10.0 RMB
- 📊 费率: 2%

**预期流程**:
1. 生成支付信息和 nonce
2. 小明签名授权支付
3. 操作员提交签名执行支付
4. 验证 ERC3009 签名
5. 执行代币转账
6. 余额变化:
   - 小明: -10.0 RMB
   - 咖啡店: +9.8 RMB
   - 操作员: +0.2 RMB (手续费)

---

## 🧪 第四阶段：单元测试验证

### RMBToken 合约测试
```bash
npx hardhat test test/RMBToken.test.js --network localhost
```

### Escrow 功能测试
```bash
npx hardhat test test/Escrow.functional.test.js --network localhost
```

---

## 📊 完整测试顺序总结

### 🎯 推荐测试顺序 (新手)

```bash
# 1. 启动区块链
npx hardhat node

# 2. 部署基础合约
npx hardhat run scripts/deploy-all.js --network localhost

# 3. 部署简单收集器
npx hardhat run scripts/deploy-simple-collector.js --network localhost

# 4. 验证部署
npx hardhat run scripts/verify-deployment.js --network localhost

#57. 单元测试
npx hardhat test --network localhost
```

### 🚀 高级测试顺序 (ERC3009)

```bash
# 1-4. 同上基础步骤

# 5. 部署 ERC3009 收集器
npx hardhat run scripts/deploy-erc3009-collector.js --network localhost

# 6. ERC3009 签名支付演示
npx hardhat run scripts/coffee-payment-erc3009-demo.js --network localhost

# 7. 完整验证
npx hardhat run scripts/verify-deployment.js --network localhost
```

---

## ✅ 成功标准

### 简单支付成功标准
- [ ] 所有合约部署成功
- [ ] 权限控制正常工作
- [ ] 代币转账成功
- [ ] 费用计算正确
- [ ] 余额更新准确

### ERC3009 支付成功标准
- [ ] ERC3009 签名生成成功
- [ ] 签名验证通过
- [ ] 授权支付执行成功
- [ ] nonce 计算正确
- [ ] 域分离器匹配

---

## 🔧 故障排除

### 常见问题

#### 1. 合约地址不匹配
**现象**: `Error: contract not deployed`
**解决**: 检查脚本中的合约地址是否为最新部署的地址

#### 2. 余额不足
**现象**: `ERC20: transfer amount exceeds balance`
**解决**: 确保账户有足够的代币余额

#### 3. 授权不足
**现象**: `ERC20: insufficient allowance`
**解决**: 检查代币授权额度

#### 4. 签名验证失败
**现象**: `ERC3009: invalid signature`
**解决**: 检查签名参数和域分离器

### 重置环境
```bash
# 重启区块链网络
Ctrl+C  # 停止 hardhat node
npx hardhat node  # 重新启动

# 重新部署所有合约
npx hardhat run scripts/deploy-all.js --network localhost
```

---

## 📝 测试记录模板

```
测试日期: ____
测试环境: Hardhat 本地网络
测试类型: [ ] 简单支付 [ ] ERC3009 支付

部署结果:
- RMBToken: ________________
- Escrow: __________________
- Collector: _______________

测试结果:
- [ ] 部署成功
- [ ] 验证通过
- [ ] 支付成功
- [ ] 余额正确
